<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Y2K Murder Mystery Party — Control Room</title>

  <!-- Supabase client (browser) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Audiowide&display=swap');

    /**********************************************************************
     * ========================= TUNE THESE (TV) ==========================
     * These are the easiest knobs to tweak without breaking layout.
     **********************************************************************/
    :root{
      /* Theme */
      --bg-dark: #0a0e27;
      --cyan: #00d9ff;
      --magenta: #ff006e;
      --purple: #9d00ff;
      --neon-pink: #ff10f0;
      --neon-blue: #00ffff;
      --text-light: #f0f0f0;

      /* Layout */
      --hud-padding: 40px;          /* padding around the whole top band */
      --top-band-height: 420px;     /* height of the top band */

      /* Left/Right column width.
         If you want the left “System Stability” and right “Spotlight/Ticker”
         to be WIDER, increase this number. */
      --side-col-width: 560px;      /* <-- WIDEN LEFT/RIGHT HERE */

      /* Countdown sizing */
      --countdown-font: 132px;      /* big pink digits */
      --countdown-title: 30px;
      --countdown-label: 20px;

      /* Countdown glow (lower = more readable) */
      --glow1: 5px;                 /* subtle close glow */
      --glow2: 10px;                /* mid glow */
      --glow3: 18px;                /* far glow */

      /* System Stability sizing */
      --stability-title: 40px;
      --stability-label: 35px;
      --stability-percent: 30px;

      /* Spotlight sizing */
      --spotlight-name: 40px;
      --spotlight-title: 35px;
      --spotlight-desc: 30px;

      /* Ticker sizing */
      --ticker-height: 54px;
      --ticker-font: 35px;

      /* Polaroid name sizes (these are MAX sizes; JS auto-fits down if needed) */
      --polaroid-character-max: 30px; /* <-- MAKE BIGGER/SMALLER HERE */
      --polaroid-realname-max: 18px;  /* <-- MAKE BIGGER/SMALLER HERE */
    }

    body {
      background: linear-gradient(135deg, var(--bg-dark) 0%, #1a0a3a 100%);
      color: var(--text-light);
      font-family: 'Audiowide', sans-serif;
      overflow: hidden;
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }

    /* ============= TOP BAND (TV MODE) ============= */
    .top-band {
      display: grid;

      /* IMPORTANT: fixed side width so left/right can widen.
         Center uses the remaining space. */
      grid-template-columns: var(--side-col-width) 1fr var(--side-col-width);

      gap: 30px;
      padding: var(--hud-padding);
      background: linear-gradient(180deg, rgba(10, 14, 39, 0.95) 0%, rgba(26, 10, 58, 0.9) 100%);
      border-bottom: 2px solid var(--cyan);
      box-shadow: 0 0 30px rgba(0, 217, 255, 0.3);
      height: var(--top-band-height);
      flex-shrink: 0;
      align-items: center;
    }

    /* --- TOP LEFT: SYSTEM STABILITY --- */
    .system-stability {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: flex-start;
      gap: 14px;
      padding-right: 10px;
      width: 100%;
    }

    .system-label {
      font-family: 'Orbitron', monospace;
      font-size: var(--stability-title);
      font-weight: 900;
      letter-spacing: 3px;
      color: var(--cyan);
      text-shadow: 0 0 12px var(--cyan);
      margin-bottom: 6px;
      text-transform: uppercase;
    }

    .system-bar-container {
      display: flex;
      align-items: center;
      gap: 14px;
      width: 100%;
    }

    .system-bar-label {
      font-size: var(--stability-label);
      color: var(--magenta);
      width: 90px;
      text-transform: uppercase;
      font-weight: 900;
      letter-spacing: 1px;
      font-family: 'Orbitron', monospace;
      flex: 0 0 auto;
    }

    .system-bar {
      flex: 1;
      height: 14px;
      background: rgba(0, 255, 0, 0.15);
      border: 1px solid rgba(0, 255, 0, 0.3);
      border-radius: 3px;
      overflow: hidden;
      position: relative;
      min-width: 0;
    }

    .system-bar-fill {
      height: 100%;
      box-shadow: 0 0 12px;
      will-change: width, background-color;
      transition: width 0.3s ease, background-color 0.3s ease, box-shadow 0.3s ease;
    }

    .system-bar-percent {
      font-size: var(--stability-percent);
      color: var(--cyan);
      width: 84px;
      text-align: right;
      font-weight: 900;
      font-family: 'Orbitron', monospace;
      letter-spacing: 1px;
      flex: 0 0 auto;
    }

    /* --- TOP CENTER: COUNTDOWN & EQUALIZER --- */
    .center-panel {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 16px;
      width: 100%;
      min-width: 0;
    }

    .countdown-title {
      font-family: 'Orbitron', monospace;
      font-size: var(--countdown-title);
      font-weight: 900;
      letter-spacing: 4px;
      color: var(--cyan);
      text-shadow: 0 0 16px var(--cyan);
      text-transform: uppercase;
      text-align: center;
    }

    .countdown {
      font-family: 'Orbitron', monospace;
      font-size: var(--countdown-font);
      font-weight: 900;
      color: var(--neon-pink);

      /* Reduced glow for readability */
      text-shadow:
        0 0 var(--glow1) var(--neon-pink),
        0 0 var(--glow2) var(--neon-pink),
        0 0 var(--glow3) var(--magenta);

      letter-spacing: 6px;
      line-height: 1;
      text-align: center;
      white-space: nowrap;
    }

    .countdown-label {
      font-family: 'Orbitron', monospace;
      font-size: var(--countdown-label);
      letter-spacing: 4px;
      color: var(--cyan);
      text-shadow: 0 0 12px var(--cyan);
      margin-top: -10px;
      text-transform: uppercase;
      text-align: center;
    }

    /* EQUALIZER */
    .equalizer {
      display: flex;
      align-items: flex-end;
      gap: 4px;
      height: 70px;
      width: 100%;
      justify-content: center;
      margin-top: 4px;
    }

    .eq-bar {
      width: 5px;
      background: linear-gradient(180deg, var(--cyan) 0%, var(--neon-blue) 100%);
      border-radius: 2px;
      box-shadow: 0 0 12px var(--cyan);
      animation: eq-dance 0.6s ease-in-out infinite;
      transform-origin: bottom center;
      flex-shrink: 0;
    }

    .eq-bar:nth-child(1) { animation-delay: 0.0s; animation-duration: 0.7s; height: 18px; }
    .eq-bar:nth-child(2) { animation-delay: 0.08s; animation-duration: 0.65s; height: 26px; }
    .eq-bar:nth-child(3) { animation-delay: 0.16s; animation-duration: 0.68s; height: 34px; }
    .eq-bar:nth-child(4) { animation-delay: 0.24s; animation-duration: 0.62s; height: 42px; }
    .eq-bar:nth-child(5) { animation-delay: 0.32s; animation-duration: 0.75s; height: 50px; }
    .eq-bar:nth-child(6) { animation-delay: 0.4s; animation-duration: 0.66s; height: 56px; }
    .eq-bar:nth-child(7) { animation-delay: 0.48s; animation-duration: 0.72s; height: 52px; }
    .eq-bar:nth-child(8) { animation-delay: 0.56s; animation-duration: 0.64s; height: 44px; }
    .eq-bar:nth-child(9) { animation-delay: 0.64s; animation-duration: 0.7s; height: 36px; }
    .eq-bar:nth-child(10){ animation-delay: 0.72s; animation-duration: 0.65s; height: 28px; }
    .eq-bar:nth-child(11){ animation-delay: 0.8s; animation-duration: 0.68s; height: 22px; }
    .eq-bar:nth-child(12){ animation-delay: 0.88s; animation-duration: 0.62s; height: 30px; }
    .eq-bar:nth-child(13){ animation-delay: 0.96s; animation-duration: 0.75s; height: 38px; }
    .eq-bar:nth-child(14){ animation-delay: 1.04s; animation-duration: 0.66s; height: 46px; }
    .eq-bar:nth-child(15){ animation-delay: 1.12s; animation-duration: 0.72s; height: 56px; }
    .eq-bar:nth-child(16){ animation-delay: 1.2s; animation-duration: 0.64s; height: 52px; }
    .eq-bar:nth-child(17){ animation-delay: 1.28s; animation-duration: 0.7s; height: 44px; }
    .eq-bar:nth-child(18){ animation-delay: 1.36s; animation-duration: 0.65s; height: 36px; }
    .eq-bar:nth-child(19){ animation-delay: 1.44s; animation-duration: 0.68s; height: 28px; }
    .eq-bar:nth-child(20){ animation-delay: 1.52s; animation-duration: 0.62s; height: 18px; }

    @keyframes eq-dance {
      0%, 100% { transform: scaleY(1); }
      50% { transform: scaleY(2.2); }
    }

    /* --- TOP RIGHT: Spotlight + Ticker Strip --- */
    .right-panel {
      display: flex;
      flex-direction: column;
      gap: 14px;
      justify-content: center;
      align-items: stretch;
      width: 100%;
    }

    .spotlight-box {
      padding: 18px;
      background: rgba(0, 217, 255, 0.05);
      border: 1px solid rgba(0, 217, 255, 0.35);
      border-radius: 6px;
      box-shadow: 0 0 26px rgba(0, 217, 255, 0.15);
      min-height: 240px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      width: 100%;
    }

    .spotlight {
      display: flex;
      flex-direction: column;
      text-align: center;
      gap: 10px;
      width: 100%;
      animation: fade-in 0.7s ease-in-out forwards;
    }

    .spotlight-name {
      font-family: 'Orbitron', monospace;
      font-size: var(--spotlight-name);
      font-weight: 900;
      color: var(--neon-pink);
      text-shadow: 0 0 18px var(--neon-pink);
      letter-spacing: 1px;
    }

    .spotlight-title {
      font-size: var(--spotlight-title);
      color: var(--cyan);
      text-shadow: 0 0 10px var(--cyan);
      text-transform: uppercase;
      letter-spacing: 2px;
      font-family: 'Orbitron', monospace;
      font-weight: 900;
    }

    .spotlight-desc {
      font-size: var(--spotlight-desc);
      color: var(--text-light);
      line-height: 1.5;
      max-height: 92px;
      overflow: hidden;
      opacity: 0.95;
    }

    .spotlight-underline {
      height: 2px;
      margin-top: 4px;
      background: linear-gradient(90deg, transparent, var(--cyan), transparent);
      box-shadow: 0 0 12px var(--cyan);
      animation: underline-pulse 2s ease-in-out infinite;
    }

    @keyframes underline-pulse {
      0%, 100% { opacity: 0.5; }
      50% { opacity: 1; }
    }

    /* Ticker strip (short + wide) */
    .ticker-strip {
      height: var(--ticker-height);
      background: rgba(0, 0, 0, 0.18);
      border: 1px solid rgba(0, 217, 255, 0.30);
      border-radius: 6px;
      overflow: hidden;
      display: flex;
      align-items: center;
      box-shadow: 0 0 18px rgba(0, 217, 255, 0.12);
      padding: 0 12px;
      width: 100%;
    }

    .ticker {
      display: flex;
      gap: 46px;
      will-change: transform;
      animation: ticker-scroll 24s linear infinite;
      align-items: center;
    }

    .ticker-item {
      white-space: nowrap;
      font-family: 'Orbitron', monospace;
      font-size: var(--ticker-font);
      color: var(--text-light);
      letter-spacing: 0.5px;
    }

    .ticker-symbol { color: var(--neon-pink); font-weight: 900; margin-right: 10px; }
    .ticker-change { font-size: 13px; font-weight: 900; margin-left: 6px; }
    .ticker-change.up { color: #00ff00; text-shadow: 0 0 10px #00ff00; }
    .ticker-change.down { color: #ff3333; text-shadow: 0 0 10px #ff3333; }
    .ticker-alert { color: var(--magenta); font-size: 13px; margin-left: 6px; text-shadow: 0 0 10px var(--magenta); }
    .ticker-critical { color: #ff0000; font-size: 13px; font-weight: 900; margin-left: 6px; text-shadow: 0 0 14px #ff0000; animation: critical-pulse 1s ease-in-out infinite; }
    .ticker-question { color: var(--purple); font-size: 13px; font-weight: 900; margin-left: 6px; text-shadow: 0 0 12px var(--purple); }

    @keyframes critical-pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }

    @keyframes ticker-scroll {
      0% { transform: translateX(0); }
      100% { transform: translateX(-50%); }
    }

    /* ============= PHOTO WALL (2 rows × 10 cards) ============= */
    .photo-wall {
      flex: 1;
      display: grid;
      grid-template-columns: repeat(10, 1fr);
      gap: 20px;
      padding: 30px;
      align-content: start;
      overflow: hidden;
      grid-auto-flow: dense;
    }

    .guest-card {
      display: flex;
      flex-direction: column;
      background: #f5f5f0;
      border: 8px solid #f5f5f0;
      border-bottom: 35px solid #f5f5f0;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5), 0 0 20px rgba(0, 217, 255, 0.15);
      overflow: visible;
      cursor: default;
      transform: perspective(1000px) rotateZ(-1deg);
      position: relative;
      opacity: 0;
      animation: card-slide-in 0.9s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
    }

    .guest-card.pulse {
      animation: card-pulse-glow 1.2s ease-out forwards;
    }

    @keyframes card-pulse-glow {
      0%   { box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5), 0 0 40px rgba(255, 16, 240, 0.6); }
      50%  { box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5), 0 0 70px rgba(255, 16, 240, 0.95); }
      100% { box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5), 0 0 20px rgba(0, 217, 255, 0.15); }
    }

    @keyframes card-slide-in {
      from { opacity: 0; transform: perspective(1000px) rotateZ(-1deg) translateY(60px); }
      to   { opacity: 1; transform: perspective(1000px) rotateZ(-1deg) translateY(0); }
    }

    .guest-image {
      width: 100%;
      height: auto;
      object-fit: contain;
      background: #000;
      display: block;
    }

    .guest-info {
      padding: 12px 8px;
      background: #f5f5f0;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      gap: 4px;
      text-align: center;
      min-height: 46px;
    }

    .guest-character {
      font-family: 'Orbitron', monospace;
      font-weight: 900;
      color: var(--neon-pink);
      line-height: 1.12;
      text-shadow: none;
    }

    .guest-real-name {
      color: #333;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 900;
      font-family: 'Orbitron', monospace;
    }

    ::-webkit-scrollbar { display: none; }
  </style>
</head>

<body>
  <!-- TOP BAND -->
  <div class="top-band">

    <!-- LEFT: System Stability -->
    <div class="system-stability">
      <div class="system-label">Y2K SYSTEM STABILITY</div>

      <div class="system-bar-container">
        <div class="system-bar-label">Power</div>
        <div class="system-bar"><div class="system-bar-fill power"></div></div>
        <div class="system-bar-percent" id="powerPercent">100%</div>
      </div>

      <div class="system-bar-container">
        <div class="system-bar-label">Bank</div>
        <div class="system-bar"><div class="system-bar-fill bank"></div></div>
        <div class="system-bar-percent" id="bankPercent">100%</div>
      </div>

      <div class="system-bar-container">
        <div class="system-bar-label">Air</div>
        <div class="system-bar"><div class="system-bar-fill air"></div></div>
        <div class="system-bar-percent" id="airPercent">100%</div>
      </div>

      <div class="system-bar-container">
        <div class="system-bar-label">Net</div>
        <div class="system-bar"><div class="system-bar-fill net"></div></div>
        <div class="system-bar-percent" id="netPercent">100%</div>
      </div>
    </div>

    <!-- CENTER: Countdown & Equalizer -->
    <div class="center-panel">
      <div class="countdown-title">DJ NEON'S MILLENNIUM COUNTDOWN</div>
      <div class="countdown" id="countdown">00:00:00</div>
      <div class="countdown-label">TILL MILLENNIUM</div>

      <div class="equalizer" aria-hidden="true">
        <div class="eq-bar"></div><div class="eq-bar"></div><div class="eq-bar"></div><div class="eq-bar"></div><div class="eq-bar"></div>
        <div class="eq-bar"></div><div class="eq-bar"></div><div class="eq-bar"></div><div class="eq-bar"></div><div class="eq-bar"></div>
        <div class="eq-bar"></div><div class="eq-bar"></div><div class="eq-bar"></div><div class="eq-bar"></div><div class="eq-bar"></div>
        <div class="eq-bar"></div><div class="eq-bar"></div><div class="eq-bar"></div><div class="eq-bar"></div><div class="eq-bar"></div>
      </div>
    </div>

    <!-- RIGHT: Spotlight ALWAYS + Ticker strip ALWAYS -->
    <div class="right-panel">
      <div class="spotlight-box" id="spotlightBox"></div>

      <div class="ticker-strip">
        <div class="ticker" id="ticker">
          <!-- set 1 -->
          <span class="ticker-item"><span class="ticker-symbol">Guests</span><span class="guest-count">0</span>/20 Checked In</span>
          <span class="ticker-item"><span class="ticker-symbol">MusicNetHub</span><span class="ticker-change up">▲32%</span></span>
          <span class="ticker-item"><span class="ticker-symbol">Sterling Soundscapes</span><span class="ticker-change down">▼12%</span></span>
          <span class="ticker-item"><span class="ticker-symbol">Napster</span><span class="ticker-alert">Lawsuit Pending</span></span>
          <span class="ticker-item"><span class="ticker-symbol">Y2K Bug Risk</span><span class="ticker-critical">CRITICAL</span></span>
          <span class="ticker-item"><span class="ticker-symbol">ARE WE READY?</span><span class="ticker-question">???</span></span>

          <!-- set 2 (duplicate for smooth loop) -->
          <span class="ticker-item"><span class="ticker-symbol">Guests</span><span class="guest-count">0</span>/20 Checked In</span>
          <span class="ticker-item"><span class="ticker-symbol">MusicNetHub</span><span class="ticker-change up">▲32%</span></span>
          <span class="ticker-item"><span class="ticker-symbol">Sterling Soundscapes</span><span class="ticker-change down">▼12%</span></span>
          <span class="ticker-item"><span class="ticker-symbol">Napster</span><span class="ticker-alert">Lawsuit Pending</span></span>
          <span class="ticker-item"><span class="ticker-symbol">Y2K Bug Risk</span><span class="ticker-critical">CRITICAL</span></span>
          <span class="ticker-item"><span class="ticker-symbol">ARE WE READY?</span><span class="ticker-question">???</span></span>
        </div>
      </div>
    </div>
  </div>

  <!-- PHOTO WALL -->
  <div class="photo-wall" id="photoWall"></div>

  <script>
    /**********************************************************************
     * ===================== SUPER OBVIOUS CONFIG =========================
     * 1) SET YOUR COUNTDOWN TARGET TIME HERE
     *    - This is a daily countdown to the next time today (or tomorrow).
     **********************************************************************/
    const COUNTDOWN_TARGET_TIME = { hours: 22, minutes: 0, seconds: 0 }; // <-- EDIT THIS

    /**********************************************************************
     * 2) SUPABASE CONNECTION
     *    - Use your ANON key here (NOT service_role)
     **********************************************************************/
    const SUPABASE_URL = 'https://hnlgehudesxzhmeubbxr.supabase.co';
    const SUPABASE_ANON_KEY = 'sb_publishable_iRerfEFzpd4LWrauNc0jRA_TGj8uA_O';

    /**********************************************************************
     * 3) BEHAVIOR SETTINGS
     **********************************************************************/
    const CONFIG = {
      MAX_GUESTS: 20,
      SPOTLIGHT_ROTATE_MS: 15000,  // spotlight rotates through checked-in guests
    };

    /**********************************************************************
     * 4) POLAROID TEXT AUTO-FIT SETTINGS (BIG TEXT)
     *    - These are MAX sizes; text shrinks down automatically if needed.
     **********************************************************************/
    const POLAROID_TEXT = {
      CHARACTER_MAX: parseInt(getComputedStyle(document.documentElement).getPropertyValue('--polaroid-character-max')) || 30,
      CHARACTER_MIN: 12,
      REALNAME_MAX: parseInt(getComputedStyle(document.documentElement).getPropertyValue('--polaroid-realname-max')) || 18,
      REALNAME_MIN: 10,
    };

    // ---- Prevent "Identifier 'supabase' already declared" issues ----
    const { createClient } = window.supabase;
    const sb = window.__y2kSupabaseClient
      || (window.__y2kSupabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY));

    // ============= STATE =============
    const guestMap = new Map(); // key: character_name -> latest row
    const cardMap  = new Map(); // key: character_name -> DOM element
    let spotlightIndex = 0;

    // ============= COUNTDOWN LOGIC =============
    function updateCountdown() {
      const now = new Date();
      const target = new Date();
      target.setHours(COUNTDOWN_TARGET_TIME.hours, COUNTDOWN_TARGET_TIME.minutes, COUNTDOWN_TARGET_TIME.seconds, 0);
      if (now > target) target.setDate(target.getDate() + 1);

      const diff = Math.max(0, target - now);
      const totalSeconds = diff / 1000;

      const hours = String(Math.floor(diff / 3600000)).padStart(2, '0');
      const minutes = String(Math.floor((diff % 3600000) / 60000)).padStart(2, '0');
      const seconds = String(Math.floor((diff % 60000) / 1000)).padStart(2, '0');

      document.getElementById('countdown').textContent = `${hours}:${minutes}:${seconds}`;
      updateSystemBars(totalSeconds);
    }

    function updateSystemBars(totalSeconds) {
      const CRITICAL_THRESHOLD = 2.5 * 3600; // 2.5 hours

      let healthPercent = totalSeconds > CRITICAL_THRESHOLD ? 100 : Math.max(0, (totalSeconds / CRITICAL_THRESHOLD) * 100);

      const powerHealth = Math.max(0, healthPercent - (100 - healthPercent) * 0.15);
      const bankHealth  = Math.max(0, healthPercent - (100 - healthPercent) * 0.12);
      const airHealth   = Math.max(0, healthPercent - (100 - healthPercent) * 0.18);
      const netHealth   = Math.max(0, healthPercent - (100 - healthPercent) * 0.10);

      document.querySelector('.system-bar-fill.power').style.width = powerHealth + '%';
      document.querySelector('.system-bar-fill.bank').style.width  = bankHealth + '%';
      document.querySelector('.system-bar-fill.air').style.width   = airHealth + '%';
      document.querySelector('.system-bar-fill.net').style.width   = netHealth + '%';

      document.getElementById('powerPercent').textContent = Math.round(powerHealth) + '%';
      document.getElementById('bankPercent').textContent  = Math.round(bankHealth) + '%';
      document.getElementById('airPercent').textContent   = Math.round(airHealth) + '%';
      document.getElementById('netPercent').textContent   = Math.round(netHealth) + '%';

      updateBarColor('.system-bar-fill.power', powerHealth);
      updateBarColor('.system-bar-fill.bank', bankHealth);
      updateBarColor('.system-bar-fill.air', airHealth);
      updateBarColor('.system-bar-fill.net', netHealth);
    }

    function updateBarColor(selector, health) {
      const bar = document.querySelector(selector);
      let bgColor, glowColor;

      if (health > 66) {
        bgColor = '#00ff00'; glowColor = '#00ff00';
      } else if (health > 33) {
        bgColor = '#ffff00'; glowColor = '#ffff00';
      } else {
        bgColor = '#ff3333'; glowColor = '#ff3333';
      }

      bar.style.backgroundColor = bgColor;
      bar.style.boxShadow = `0 0 12px ${glowColor}`;
    }

    // ============= HELPERS =============
    function escapeHTML(text) {
      const div = document.createElement('div');
      div.textContent = text ?? '';
      return div.innerHTML;
    }

    function getCheckedInGuestsSorted() {
      // Only guests with real_name count as "checked in"
      const guests = Array.from(guestMap.values()).filter(g => g && g.real_name);
      guests.sort((a, b) => {
        const ta = a.created_at ? new Date(a.created_at).getTime() : 0;
        const tb = b.created_at ? new Date(b.created_at).getTime() : 0;
        return ta - tb;
      });
      return guests;
    }

    function updateGuestCountTicker() {
      const count = getCheckedInGuestsSorted().length;
      document.querySelectorAll('.guest-count').forEach(el => el.textContent = String(count));
    }

    // Auto-fit text inside polaroid label area (BIG text but always fits)
    function fitText(el, maxPx, minPx) {
      if (!el) return;
      el.style.whiteSpace = 'nowrap';
      el.style.overflow = 'hidden';
      el.style.textOverflow = 'ellipsis';

      let size = maxPx;
      el.style.fontSize = size + 'px';

      // Reduce until it fits width
      while (size > minPx && el.scrollWidth > el.clientWidth) {
        size -= 1;
        el.style.fontSize = size + 'px';
      }
    }

    function fitPolaroidText(card) {
      const nameEl = card.querySelector('.guest-character');
      const realEl = card.querySelector('.guest-real-name');

      // BIG default sizes (then shrink down if needed)
      fitText(nameEl, POLAROID_TEXT.CHARACTER_MAX, POLAROID_TEXT.CHARACTER_MIN);
      fitText(realEl, POLAROID_TEXT.REALNAME_MAX, POLAROID_TEXT.REALNAME_MIN);
    }

    // ============= PHOTO WALL RENDERING =============
    function renderNewGuest(guest, { isNew } = { isNew: false }) {
      const photoWall = document.getElementById('photoWall');

      const card = document.createElement('div');
      card.className = 'guest-card' + (isNew ? ' pulse' : '');

      const imageHTML = guest.photo_url
        ? `<img src="${guest.photo_url}" alt="${escapeHTML(guest.character_name)}" class="guest-image" onerror="this.style.display='none'">`
        : '';

      card.innerHTML = `
        ${imageHTML}
        <div class="guest-info">
          <div class="guest-character">${escapeHTML(guest.character_name || '')}</div>
          <div class="guest-real-name">${escapeHTML(guest.real_name || '')}</div>
        </div>
      `;

      photoWall.appendChild(card);
      cardMap.set(guest.character_name, card);

      // Fit text after it’s in DOM
      requestAnimationFrame(() => fitPolaroidText(card));
    }

    function updateExistingGuestCard(guest) {
      const card = cardMap.get(guest.character_name);
      if (!card) return;

      const nameEl = card.querySelector('.guest-character');
      const realEl = card.querySelector('.guest-real-name');
      if (nameEl) nameEl.textContent = guest.character_name ?? '';
      if (realEl) realEl.textContent = guest.real_name ?? '';

      // Update/add image if needed
      const img = card.querySelector('img.guest-image');
      if (guest.photo_url) {
        if (img) {
          if (img.src !== guest.photo_url) img.src = guest.photo_url;
        } else {
          const newImg = document.createElement('img');
          newImg.className = 'guest-image';
          newImg.alt = guest.character_name || '';
          newImg.src = guest.photo_url;
          newImg.onerror = () => { newImg.style.display = 'none'; };
          card.insertBefore(newImg, card.firstChild);
        }
      }

      requestAnimationFrame(() => fitPolaroidText(card));
    }

    /**********************************************************************
     * ===================== REALTIME CARD FIX =============================
     * This is the bug you described:
     * - Sometimes "real_name" is saved first
     * - and "photo_url" arrives slightly later in a separate UPDATE
     * If the card doesn't exist yet, we MUST create it when either:
     *   (A) real_name becomes non-null  OR
     *   (B) photo_url becomes non-null
     * (as long as they are "checked in" = has real_name)
     **********************************************************************/
    function ensureCardForCheckedInGuest(guest, isNewPulse = false) {
      if (!guest || !guest.character_name) return;
      if (!guest.real_name) return; // we only display checked-in guests

      const alreadyHasCard = cardMap.has(guest.character_name);

      if (!alreadyHasCard) {
        // Only render if we still have room
        const currentCount = getCheckedInGuestsSorted().length;
        if (currentCount <= CONFIG.MAX_GUESTS) {
          renderNewGuest(guest, { isNew: isNewPulse });
        }
      } else {
        updateExistingGuestCard(guest);
      }
    }

    // ============= SPOTLIGHT (always visible) =============
    function renderSpotlight() {
      const box = document.getElementById('spotlightBox');
      const guests = getCheckedInGuestsSorted();

      if (guests.length === 0) {
        box.innerHTML = `
          <div class="spotlight">
            <div class="spotlight-name">AWAITING CHECK-INS…</div>
            <div class="spotlight-title">SYSTEM STATUS</div>
            <div class="spotlight-desc">No guests have checked in yet. Send them to the upload page and let the chaos begin.</div>
            <div class="spotlight-underline"></div>
          </div>
        `;
        return;
      }

      const guest = guests[spotlightIndex % guests.length];
      spotlightIndex++;

      box.innerHTML = `
        <div class="spotlight">
          <div class="spotlight-name">${escapeHTML(guest.character_name)}</div>
          <div class="spotlight-title">${escapeHTML(guest.character_title || 'Mystery Guest')}</div>
          <div class="spotlight-desc">${escapeHTML(guest.character_description || 'No description')}</div>
          <div class="spotlight-underline"></div>
        </div>
      `;
    }

    // ============= SUPABASE REALTIME + INITIAL LOAD =============
    async function initializeGuests() {
      try {
        // Initial fetch: checked-in guests only
        const { data, error } = await sb
          .from('guests')
          .select('*')
          .not('real_name', 'is', null)
          .order('created_at', { ascending: true });

        if (error) {
          console.error('Initial fetch error:', error);
          return;
        }

        // Load initial guests (no pulse for existing)
        data.slice(0, CONFIG.MAX_GUESTS).forEach(guest => {
          if (guest?.character_name && guest?.real_name) {
            guestMap.set(guest.character_name, guest);
            renderNewGuest(guest, { isNew: false });
          }
        });

        updateGuestCountTicker();
        renderSpotlight();

        // Real-time subscription
        sb
          .channel('guests-realtime')
          .on('postgres_changes', { event: '*', schema: 'public', table: 'guests' }, (payload) => {
            const guest = payload.new;
            const oldRow = payload.old;

            if (!guest || !guest.character_name) return;

            // previous + current state
            const prev = guestMap.get(guest.character_name) || oldRow || {};
            const wasCheckedIn = !!prev.real_name;
            const isCheckedIn  = !!guest.real_name;

            // Store latest row no matter what
            guestMap.set(guest.character_name, guest);

            // If they JUST checked in (real_name null -> value), pulse and ensure card
            if (!wasCheckedIn && isCheckedIn) {
              ensureCardForCheckedInGuest(guest, true);
              updateGuestCountTicker();
              renderSpotlight();
              return;
            }

            // If already checked in:
            // IMPORTANT FIX: If their photo_url arrives later (or changes), make sure a card exists and updates.
            if (isCheckedIn) {
              const photoJustArrived = !prev.photo_url && !!guest.photo_url;
              const photoChanged = !!guest.photo_url && prev.photo_url !== guest.photo_url;
              const nameChanged = (prev.real_name !== guest.real_name) || (prev.character_name !== guest.character_name);

              if (photoJustArrived || photoChanged || nameChanged) {
                // If card didn’t exist yet, create it now (this fixes your “refresh needed” bug)
                ensureCardForCheckedInGuest(guest, photoJustArrived);
              }
            }

            updateGuestCountTicker();
          })
          .subscribe((status) => {
            console.log('[Realtime status]', status);
          });

      } catch (err) {
        console.error('Initialization error:', err);
      }
    }

    // ============= INIT =============
    function init() {
      updateCountdown();
      initializeGuests();

      // loops
      setInterval(updateCountdown, 1000);
      setInterval(renderSpotlight, CONFIG.SPOTLIGHT_ROTATE_MS);

      // keep ticker count fresh even if nothing else triggers
      setInterval(updateGuestCountTicker, 5000);
    }

    init();
  </script>
</body>
</html>
