<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Y2K Murder Mystery Party — Control Room</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Audiowide&display=swap');

    :root{
      --bg-dark: #0a0e27;
      --cyan: #00d9ff;
      --magenta: #ff006e;
      --purple: #9d00ff;
      --neon-pink: #ff10f0;
      --neon-blue: #00ffff;
      --text-light: #f0f0f0;

      /* ============================================================
         ✅✅✅ TV MODE CONTROLS (EASY TO TUNE) ✅✅✅
         Change these numbers to size/space the top HUD.
         ============================================================ */
      --hud-padding: 40px;           /* Space from TV edges (fixes cut-off edges) */
      --top-band-height: 420px;      /* Height of the top band */
      --side-col-width: 520px;       /* Width of left & right columns (make wider if there’s empty space) */
      --hud-gap: 40px;               /* Gap between left/center/right inside top band */

      /* ============================================================
         ✅ TEXT SIZE TUNING (readability on TV)
         ============================================================ */
      --countdown-font: 150px;       /* BIG countdown */
      --countdown-title: 34px;
      --countdown-label: 22px;

      --stability-title: 38px;
      --stability-label: 30px;
      --stability-percent: 26px;

      --spotlight-name: 40px;
      --spotlight-title: 30px;
      --spotlight-desc: 26px;

      --ticker-height: 62px;
      --ticker-font: 30px;

      /* ============================================================
         ✅ COUNTDOWN GLOW TUNING (make more readable)
         Reduce blur/spread by lowering these values.
         ============================================================ */
      --countdown-glow-1: 6px;
      --countdown-glow-2: 14px;
      --countdown-glow-3: 26px;
    }

    body {
      background: linear-gradient(135deg, var(--bg-dark) 0%, #1a0a3a 100%);
      color: var(--text-light);
      font-family: 'Audiowide', sans-serif;
      overflow: hidden;
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }

    /* ============= TOP BAND (TV MODE) ============= */
    .top-band {
      display: grid;
      grid-template-columns: var(--side-col-width) 1fr var(--side-col-width);
      gap: var(--hud-gap);
      padding: var(--hud-padding);
      background: linear-gradient(180deg, rgba(10, 14, 39, 0.95) 0%, rgba(26, 10, 58, 0.9) 100%);
      border-bottom: 2px solid var(--cyan);
      box-shadow: 0 0 30px rgba(0, 217, 255, 0.3);
      height: var(--top-band-height);
      flex-shrink: 0;
    }

    /* --- LEFT: SYSTEM STABILITY --- */
    .system-stability {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: flex-start;
      gap: 14px;
      padding-right: 10px;
      min-width: 0;
    }

    .system-label {
      font-family: 'Orbitron', monospace;
      font-size: var(--stability-title);
      font-weight: 900;
      letter-spacing: 3px;
      color: var(--cyan);
      text-shadow: 0 0 12px var(--cyan);
      margin-bottom: 6px;
      text-transform: uppercase;
    }

    .system-bar-container {
      display: flex;
      align-items: center;
      gap: 12px;
      width: 100%;
      min-width: 0;
    }

    .system-bar-label {
      font-size: var(--stability-label);
      color: var(--magenta);
      width: 80px;              /* make this wider if labels feel cramped */
      text-transform: uppercase;
      font-weight: 900;
      letter-spacing: 1px;
      font-family: 'Orbitron', monospace;
      flex-shrink: 0;
    }

    .system-bar {
      flex: 1;
      height: 14px;
      background: rgba(0, 255, 0, 0.15);
      border: 1px solid rgba(0, 255, 0, 0.3);
      border-radius: 3px;
      overflow: hidden;
      position: relative;
      min-width: 0;
    }

    .system-bar-fill {
      height: 100%;
      box-shadow: 0 0 12px;
      will-change: width, background-color;
      transition: width 0.3s ease, background-color 0.3s ease, box-shadow 0.3s ease;
    }

    .system-bar-percent {
      font-size: var(--stability-percent);
      color: var(--cyan);
      width: 70px;
      text-align: right;
      font-weight: 900;
      font-family: 'Orbitron', monospace;
      letter-spacing: 1px;
      flex-shrink: 0;
    }

    /* --- CENTER: COUNTDOWN & EQUALIZER --- */
    .center-panel {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center; /* center vertically in taller top band */
      gap: 18px;
      min-width: 0;
    }

    .countdown-title {
      font-family: 'Orbitron', monospace;
      font-size: var(--countdown-title);
      font-weight: 900;
      letter-spacing: 4px;
      color: var(--cyan);
      text-shadow: 0 0 16px var(--cyan);
      text-transform: uppercase;
      text-align: center;
    }

    .countdown {
      font-family: 'Orbitron', monospace;
      font-size: var(--countdown-font);
      font-weight: 900;
      color: var(--neon-pink);
      text-shadow:
        0 0 var(--countdown-glow-1) var(--neon-pink),
        0 0 var(--countdown-glow-2) var(--neon-pink),
        0 0 var(--countdown-glow-3) var(--magenta);
      letter-spacing: 6px;
      line-height: 1;
    }

    .countdown-label {
      font-family: 'Orbitron', monospace;
      font-size: var(--countdown-label);
      letter-spacing: 4px;
      color: var(--cyan);
      text-shadow: 0 0 12px var(--cyan);
      margin-top: -10px;
      text-transform: uppercase;
    }

    /* EQUALIZER */
    .equalizer {
      display: flex;
      align-items: flex-end;
      gap: 4px;
      height: 70px;
      width: 100%;
      justify-content: center;
      margin-top: 4px;
    }

    .eq-bar {
      width: 5px;
      background: linear-gradient(180deg, var(--cyan) 0%, var(--neon-blue) 100%);
      border-radius: 2px;
      box-shadow: 0 0 12px var(--cyan);
      animation: eq-dance 0.6s ease-in-out infinite;
      transform-origin: bottom center;
      flex-shrink: 0;
    }

    .eq-bar:nth-child(1) { animation-delay: 0.0s; animation-duration: 0.7s; height: 18px; }
    .eq-bar:nth-child(2) { animation-delay: 0.08s; animation-duration: 0.65s; height: 26px; }
    .eq-bar:nth-child(3) { animation-delay: 0.16s; animation-duration: 0.68s; height: 34px; }
    .eq-bar:nth-child(4) { animation-delay: 0.24s; animation-duration: 0.62s; height: 42px; }
    .eq-bar:nth-child(5) { animation-delay: 0.32s; animation-duration: 0.75s; height: 50px; }
    .eq-bar:nth-child(6) { animation-delay: 0.4s; animation-duration: 0.66s; height: 56px; }
    .eq-bar:nth-child(7) { animation-delay: 0.48s; animation-duration: 0.72s; height: 52px; }
    .eq-bar:nth-child(8) { animation-delay: 0.56s; animation-duration: 0.64s; height: 44px; }
    .eq-bar:nth-child(9) { animation-delay: 0.64s; animation-duration: 0.7s; height: 36px; }
    .eq-bar:nth-child(10){ animation-delay: 0.72s; animation-duration: 0.65s; height: 28px; }
    .eq-bar:nth-child(11){ animation-delay: 0.8s; animation-duration: 0.68s; height: 22px; }
    .eq-bar:nth-child(12){ animation-delay: 0.88s; animation-duration: 0.62s; height: 30px; }
    .eq-bar:nth-child(13){ animation-delay: 0.96s; animation-duration: 0.75s; height: 38px; }
    .eq-bar:nth-child(14){ animation-delay: 1.04s; animation-duration: 0.66s; height: 46px; }
    .eq-bar:nth-child(15){ animation-delay: 1.12s; animation-duration: 0.72s; height: 56px; }
    .eq-bar:nth-child(16){ animation-delay: 1.2s; animation-duration: 0.64s; height: 52px; }
    .eq-bar:nth-child(17){ animation-delay: 1.28s; animation-duration: 0.7s; height: 44px; }
    .eq-bar:nth-child(18){ animation-delay: 1.36s; animation-duration: 0.65s; height: 36px; }
    .eq-bar:nth-child(19){ animation-delay: 1.44s; animation-duration: 0.68s; height: 28px; }
    .eq-bar:nth-child(20){ animation-delay: 1.52s; animation-duration: 0.62s; height: 18px; }

    @keyframes eq-dance {
      0%, 100% { transform: scaleY(1); }
      50% { transform: scaleY(2.2); }
    }

    /* --- RIGHT: Spotlight ALWAYS + Ticker ALWAYS --- */
    .right-panel {
      display: flex;
      flex-direction: column;
      gap: 14px;
      justify-content: center;
      align-items: stretch;
      min-width: 0;
    }

    .spotlight-box {
      padding: 18px;
      background: rgba(0, 217, 255, 0.05);
      border: 1px solid rgba(0, 217, 255, 0.35);
      border-radius: 8px;
      box-shadow: 0 0 26px rgba(0, 217, 255, 0.15);
      min-height: 260px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      min-width: 0;
    }

    .spotlight {
      display: flex;
      flex-direction: column;
      text-align: center;
      gap: 12px;
      width: 100%;
      animation: fade-in 0.7s ease-in-out forwards;
    }

    .spotlight-name {
      font-family: 'Orbitron', monospace;
      font-size: var(--spotlight-name);
      font-weight: 900;
      color: var(--neon-pink);
      text-shadow: 0 0 18px var(--neon-pink);
      letter-spacing: 1px;
    }

    .spotlight-title {
      font-size: var(--spotlight-title);
      color: var(--cyan);
      text-shadow: 0 0 10px var(--cyan);
      text-transform: uppercase;
      letter-spacing: 2px;
      font-family: 'Orbitron', monospace;
      font-weight: 900;
    }

    .spotlight-desc {
      font-size: var(--spotlight-desc);
      color: var(--text-light);
      line-height: 1.4;
      max-height: 120px;
      overflow: hidden;
      opacity: 0.95;
    }

    .spotlight-underline {
      height: 2px;
      margin-top: 4px;
      background: linear-gradient(90deg, transparent, var(--cyan), transparent);
      box-shadow: 0 0 12px var(--cyan);
      animation: underline-pulse 2s ease-in-out infinite;
    }

    @keyframes underline-pulse {
      0%, 100% { opacity: 0.5; }
      50% { opacity: 1; }
    }

    /* Ticker strip (short + wide) */
    .ticker-strip {
      height: var(--ticker-height);
      background: rgba(0, 0, 0, 0.18);
      border: 1px solid rgba(0, 217, 255, 0.30);
      border-radius: 8px;
      overflow: hidden;
      display: flex;
      align-items: center;
      box-shadow: 0 0 18px rgba(0, 217, 255, 0.12);
      padding: 0 12px;
      min-width: 0;
    }

    .ticker {
      display: flex;
      gap: 46px;
      will-change: transform;
      animation: ticker-scroll 24s linear infinite;
      align-items: center;
    }

    .ticker-item {
      white-space: nowrap;
      font-family: 'Orbitron', monospace;
      font-size: var(--ticker-font);
      color: var(--text-light);
      letter-spacing: 0.5px;
    }

    .ticker-symbol { color: var(--neon-pink); font-weight: 900; margin-right: 10px; }
    .ticker-change { font-size: 0.9em; font-weight: 900; margin-left: 6px; }
    .ticker-change.up { color: #00ff00; text-shadow: 0 0 10px #00ff00; }
    .ticker-change.down { color: #ff3333; text-shadow: 0 0 10px #ff3333; }
    .ticker-alert { color: var(--magenta); font-size: 0.9em; margin-left: 6px; text-shadow: 0 0 10px var(--magenta); }
    .ticker-critical { color: #ff0000; font-size: 0.9em; font-weight: 900; margin-left: 6px; text-shadow: 0 0 14px #ff0000; animation: critical-pulse 1s ease-in-out infinite; }
    .ticker-question { color: var(--purple); font-size: 0.9em; font-weight: 900; margin-left: 6px; text-shadow: 0 0 12px var(--purple); }

    @keyframes critical-pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }

    @keyframes ticker-scroll {
      0% { transform: translateX(0); }
      100% { transform: translateX(-50%); }
    }

    /* ============= PHOTO WALL (2 rows × 10 cards) ============= */
    .photo-wall {
      flex: 1;
      display: grid;
      grid-template-columns: repeat(10, 1fr);
      gap: 20px;
      padding: 30px;
      align-content: start;
      overflow: hidden;
      grid-auto-flow: dense;
    }

    .guest-card {
      display: flex;
      flex-direction: column;
      background: #f5f5f0;
      border: 8px solid #f5f5f0;
      border-bottom: 35px solid #f5f5f0;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5), 0 0 20px rgba(0, 217, 255, 0.15);
      overflow: visible;
      cursor: default;
      transform: perspective(1000px) rotateZ(-1deg);
      position: relative;
      opacity: 0;
      animation: card-slide-in 0.9s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
    }

    /* Pulse effect when a NEW guest appears */
    .guest-card.pulse {
      animation: card-slide-in 0.9s cubic-bezier(0.34, 1.56, 0.64, 1) forwards, card-pulse-glow 1.2s ease-out 0.1s forwards;
    }

    @keyframes card-pulse-glow {
      0%   { box-shadow: 0 8px 25px rgba(0,0,0,0.5), 0 0 40px rgba(255,16,240,0.6); }
      50%  { box-shadow: 0 8px 25px rgba(0,0,0,0.5), 0 0 70px rgba(255,16,240,0.95); }
      100% { box-shadow: 0 8px 25px rgba(0,0,0,0.5), 0 0 20px rgba(0,217,255,0.15); }
    }

    @keyframes card-slide-in {
      from { opacity: 0; transform: perspective(1000px) rotateZ(-1deg) translateY(60px); }
      to   { opacity: 1; transform: perspective(1000px) rotateZ(-1deg) translateY(0); }
    }

    .guest-image {
      width: 100%;
      height: auto;
      object-fit: contain;
      background: #000;
      display: block;
    }

    /* ========= LABEL AREA (BIG TEXT, AUTO-FIT) ========= */
    .guest-info{
      padding: 10px 8px;
      background:#f5f5f0;
      display:flex;
      flex-direction:column;
      justify-content:center;
      gap:4px;
      text-align:center;
      height: 70px; /* Increase this if you want more white label space */
      overflow:hidden;
    }

    .guest-character,
    .guest-real-name{
      max-width:100%;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      line-height: 1.05;
      font-family:'Orbitron', monospace;
      font-weight:900;
    }

    .guest-character{ color: var(--neon-pink); }
    .guest-real-name{ color:#333; text-transform:uppercase; letter-spacing:0.5px; }

    ::-webkit-scrollbar { display: none; }
  </style>
</head>

<body>
  <!-- TOP BAND -->
  <div class="top-band">

    <!-- LEFT -->
    <div class="system-stability">
      <div class="system-label">Y2K SYSTEM STABILITY</div>

      <div class="system-bar-container">
        <div class="system-bar-label">Power</div>
        <div class="system-bar"><div class="system-bar-fill power"></div></div>
        <div class="system-bar-percent" id="powerPercent">100%</div>
      </div>

      <div class="system-bar-container">
        <div class="system-bar-label">Bank</div>
        <div class="system-bar"><div class="system-bar-fill bank"></div></div>
        <div class="system-bar-percent" id="bankPercent">100%</div>
      </div>

      <div class="system-bar-container">
        <div class="system-bar-label">Air</div>
        <div class="system-bar"><div class="system-bar-fill air"></div></div>
        <div class="system-bar-percent" id="airPercent">100%</div>
      </div>

      <div class="system-bar-container">
        <div class="system-bar-label">Net</div>
        <div class="system-bar"><div class="system-bar-fill net"></div></div>
        <div class="system-bar-percent" id="netPercent">100%</div>
      </div>
    </div>

    <!-- CENTER -->
    <div class="center-panel">
      <div class="countdown-title">DJ NEON'S MILLENNIUM COUNTDOWN</div>
      <div class="countdown" id="countdown">00:00:00</div>
      <div class="countdown-label">TILL MILLENNIUM</div>

      <div class="equalizer" aria-hidden="true">
        <div class="eq-bar"></div><div class="eq-bar"></div><div class="eq-bar"></div><div class="eq-bar"></div><div class="eq-bar"></div>
        <div class="eq-bar"></div><div class="eq-bar"></div><div class="eq-bar"></div><div class="eq-bar"></div><div class="eq-bar"></div>
        <div class="eq-bar"></div><div class="eq-bar"></div><div class="eq-bar"></div><div class="eq-bar"></div><div class="eq-bar"></div>
        <div class="eq-bar"></div><div class="eq-bar"></div><div class="eq-bar"></div><div class="eq-bar"></div><div class="eq-bar"></div>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="right-panel">
      <div class="spotlight-box" id="spotlightBox"></div>

      <div class="ticker-strip">
        <div class="ticker" id="ticker">
          <!-- set 1 -->
          <span class="ticker-item"><span class="ticker-symbol">Guests</span><span class="guest-count">0</span>/20 Checked In</span>
          <span class="ticker-item"><span class="ticker-symbol">MusicNetHub</span><span class="ticker-change up">▲32%</span></span>
          <span class="ticker-item"><span class="ticker-symbol">Sterling Soundscapes</span><span class="ticker-change down">▼12%</span></span>
          <span class="ticker-item"><span class="ticker-symbol">Napster</span><span class="ticker-alert">Lawsuit Pending</span></span>
          <span class="ticker-item"><span class="ticker-symbol">Y2K Bug Risk</span><span class="ticker-critical">CRITICAL</span></span>
          <span class="ticker-item"><span class="ticker-symbol">ARE WE READY?</span><span class="ticker-question">???</span></span>

          <!-- set 2 (duplicate for smooth loop) -->
          <span class="ticker-item"><span class="ticker-symbol">Guests</span><span class="guest-count">0</span>/20 Checked In</span>
          <span class="ticker-item"><span class="ticker-symbol">MusicNetHub</span><span class="ticker-change up">▲32%</span></span>
          <span class="ticker-item"><span class="ticker-symbol">Sterling Soundscapes</span><span class="ticker-change down">▼12%</span></span>
          <span class="ticker-item"><span class="ticker-symbol">Napster</span><span class="ticker-alert">Lawsuit Pending</span></span>
          <span class="ticker-item"><span class="ticker-symbol">Y2K Bug Risk</span><span class="ticker-critical">CRITICAL</span></span>
          <span class="ticker-item"><span class="ticker-symbol">ARE WE READY?</span><span class="ticker-question">???</span></span>
        </div>
      </div>
    </div>
  </div>

  <!-- PHOTO WALL -->
  <div class="photo-wall" id="photoWall"></div>

  <script>
    /**********************************************************************
     * =====================================================================
     * ✅✅✅ SUPER OBVIOUS TUNING / SETTINGS ✅✅✅
     * =====================================================================
     **********************************************************************/

    // 1) SET YOUR COUNTDOWN TARGET TIME HERE (daily at this time)
    const COUNTDOWN_TARGET_TIME = { hours: 22, minutes: 0, seconds: 0 }; // <-- EDIT THIS

    // 2) SUPABASE CONNECTION (ANON KEY ONLY — never service_role)
    const SUPABASE_URL = 'https://hnlgehudesxzhmeubbxr.supabase.co';
    const SUPABASE_ANON_KEY = 'sb_publishable_iRerfEFzpd4LWrauNc0jRA_TGj8uA_O';

    // 3) BEHAVIOR TUNING
    const CONFIG = {
      MAX_GUESTS: 20,
      SPOTLIGHT_ROTATE_MS: 15000, // rotate spotlight every 15s
      POLL_FALLBACK_MS: 5000,     // safety net: refetch every 5s (helps GH Pages / TV browsers)
      DEBUG: false,              // set true if you want console logs
    };

    /**********************************************************************
     * =====================================================================
     * ✅ SUPABASE CLIENT (avoid "supabase already declared")
     * =====================================================================
     **********************************************************************/
    const { createClient } = window.supabase;
    const sbClient =
      window.__y2kSupabaseClient ||
      (window.__y2kSupabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY));

    /**********************************************************************
     * =====================================================================
     * STATE
     * =====================================================================
     **********************************************************************/
    const guestMap = new Map();  // character_name -> guest row
    let spotlightIndex = 0;

    /**********************************************************************
     * =====================================================================
     * COUNTDOWN
     * =====================================================================
     **********************************************************************/
    function updateCountdown() {
      const now = new Date();
      const target = new Date();
      target.setHours(COUNTDOWN_TARGET_TIME.hours, COUNTDOWN_TARGET_TIME.minutes, COUNTDOWN_TARGET_TIME.seconds, 0);
      if (now > target) target.setDate(target.getDate() + 1);

      const diff = Math.max(0, target - now);
      const totalSeconds = diff / 1000;

      const hours = String(Math.floor(diff / 3600000)).padStart(2, '0');
      const minutes = String(Math.floor((diff % 3600000) / 60000)).padStart(2, '0');
      const seconds = String(Math.floor((diff % 60000) / 1000)).padStart(2, '0');

      document.getElementById('countdown').textContent = `${hours}:${minutes}:${seconds}`;
      updateSystemBars(totalSeconds);
    }

    function updateSystemBars(totalSeconds) {
      const CRITICAL_THRESHOLD = 2.5 * 3600;

      let healthPercent = totalSeconds > CRITICAL_THRESHOLD ? 100 : Math.max(0, (totalSeconds / CRITICAL_THRESHOLD) * 100);

      const powerHealth = Math.max(0, healthPercent - (100 - healthPercent) * 0.15);
      const bankHealth  = Math.max(0, healthPercent - (100 - healthPercent) * 0.12);
      const airHealth   = Math.max(0, healthPercent - (100 - healthPercent) * 0.18);
      const netHealth   = Math.max(0, healthPercent - (100 - healthPercent) * 0.10);

      document.querySelector('.system-bar-fill.power').style.width = powerHealth + '%';
      document.querySelector('.system-bar-fill.bank').style.width  = bankHealth + '%';
      document.querySelector('.system-bar-fill.air').style.width   = airHealth + '%';
      document.querySelector('.system-bar-fill.net').style.width   = netHealth + '%';

      document.getElementById('powerPercent').textContent = Math.round(powerHealth) + '%';
      document.getElementById('bankPercent').textContent  = Math.round(bankHealth) + '%';
      document.getElementById('airPercent').textContent   = Math.round(airHealth) + '%';
      document.getElementById('netPercent').textContent   = Math.round(netHealth) + '%';

      updateBarColor('.system-bar-fill.power', powerHealth);
      updateBarColor('.system-bar-fill.bank', bankHealth);
      updateBarColor('.system-bar-fill.air', airHealth);
      updateBarColor('.system-bar-fill.net', netHealth);
    }

    function updateBarColor(selector, health) {
      const bar = document.querySelector(selector);
      let bgColor, glowColor;

      if (health > 66) {
        bgColor = '#00ff00'; glowColor = '#00ff00';
      } else if (health > 33) {
        bgColor = '#ffff00'; glowColor = '#ffff00';
      } else {
        bgColor = '#ff3333'; glowColor = '#ff3333';
      }

      bar.style.backgroundColor = bgColor;
      bar.style.boxShadow = `0 0 12px ${glowColor}`;
    }

    /**********************************************************************
     * =====================================================================
     * HELPERS (escape HTML, cache-bust image URLs, auto-fit label text)
     * =====================================================================
     **********************************************************************/
    function escapeHTML(text) {
      const div = document.createElement('div');
      div.textContent = text ?? '';
      return div.innerHTML;
    }

    // ✅ Forces the TV/browser to fetch the newest image (prevents "needs refresh" caching behavior)
    function forceFreshImageUrl(url) {
      if (!url) return url;
      const u = new URL(url, window.location.href);
      u.searchParams.set('cb', String(Date.now()));
      return u.toString();
    }

    // ✅ Make the label text as big as possible but always fit
    function fitGuestCardText(card) {
      const info = card.querySelector('.guest-info');
      const charEl = card.querySelector('.guest-character');
      const realEl = card.querySelector('.guest-real-name');
      if (!info || !charEl || !realEl) return;

      let charSize = 30;  // start big
      let realSize = 20;  // start big

      const charMin = 10;
      const realMin = 8;

      charEl.style.fontSize = charSize + 'px';
      realEl.style.fontSize = realSize + 'px';

      for (let i = 0; i < 200; i++) {
        const fitsHeight = info.scrollHeight <= info.clientHeight;
        const charFitsWidth = charEl.scrollWidth <= charEl.clientWidth;
        const realFitsWidth = realEl.scrollWidth <= realEl.clientWidth;

        if (fitsHeight && charFitsWidth && realFitsWidth) break;

        const charOverflow = charEl.scrollWidth - charEl.clientWidth;
        const realOverflow = realEl.scrollWidth - realEl.clientWidth;

        const shouldShrinkChar =
          (charOverflow > realOverflow && charSize > charMin) || realSize <= realMin;

        if (shouldShrinkChar && charSize > charMin) {
          charSize -= 0.5;
          charEl.style.fontSize = charSize + 'px';
        } else if (realSize > realMin) {
          realSize -= 0.5;
          realEl.style.fontSize = realSize + 'px';
        } else if (charSize > charMin) {
          charSize -= 0.5;
          charEl.style.fontSize = charSize + 'px';
        } else {
          break;
        }
      }
    }

    window.addEventListener('resize', () => {
      document.querySelectorAll('.guest-card').forEach(fitGuestCardText);
    });

    /**********************************************************************
     * =====================================================================
     * PHOTO WALL RENDER/UPDATE  ✅ THIS IS THE "OLD WORKING" APPROACH
     * - Called directly from realtime events and from polling fallback.
     * - Updates photo_url whenever it changes (cache-busted).
     * =====================================================================
     **********************************************************************/
    function safeId(str) {
      return String(str || '')
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/(^-|-$)/g, '');
    }

    function renderOrUpdateGuestCard(guest, { animate = false } = {}) {
      if (!guest || !guest.character_name || !guest.real_name) return;

      const wall = document.getElementById('photoWall');
      const id = `guest-${safeId(guest.character_name)}`;
      let card = document.getElementById(id);

      const photoUrlFresh = guest.photo_url ? forceFreshImageUrl(guest.photo_url) : null;

      if (!card) {
        // Create new card
        card = document.createElement('div');
        card.id = id;
        card.className = 'guest-card' + (animate ? ' pulse' : '');

        card.innerHTML = `
          ${photoUrlFresh ? `
            <img
              src="${photoUrlFresh}"
              alt="${escapeHTML(guest.character_name)}"
              class="guest-image"
              onerror="console.error('[IMG LOAD FAIL]', this.src); this.style.display='none';"
            >
          ` : ``}
          <div class="guest-info">
            <div class="guest-character">${escapeHTML(guest.character_name)}</div>
            <div class="guest-real-name">${escapeHTML(guest.real_name)}</div>
          </div>
        `;

        wall.appendChild(card);

        requestAnimationFrame(() => fitGuestCardText(card));
        if (animate) setTimeout(() => card.classList.remove('pulse'), 1600);
        return;
      }

      // Update existing card
      card.classList.toggle('pulse', animate);

      const charEl = card.querySelector('.guest-character');
      const realEl = card.querySelector('.guest-real-name');
      if (charEl) charEl.textContent = guest.character_name ?? '';
      if (realEl) realEl.textContent = guest.real_name ?? '';

      const img = card.querySelector('img.guest-image');
      if (photoUrlFresh) {
        if (img) {
          img.src = photoUrlFresh;
        } else {
          const newImg = document.createElement('img');
          newImg.className = 'guest-image';
          newImg.alt = guest.character_name || '';
          newImg.src = photoUrlFresh;
          newImg.onerror = () => { console.error('[IMG LOAD FAIL]', newImg.src); newImg.style.display = 'none'; };
          card.insertBefore(newImg, card.firstChild);
        }
      }

      requestAnimationFrame(() => fitGuestCardText(card));
      if (animate) setTimeout(() => card.classList.remove('pulse'), 1600);
    }

    /**********************************************************************
     * =====================================================================
     * DATA FETCH / SYNC (poll fallback)
     * =====================================================================
     **********************************************************************/
    async function fetchCheckedInGuests() {
      const { data, error } = await sbClient
        .from('guests')
        .select('*')
        .not('real_name', 'is', null)
        .order('created_at', { ascending: true });

      if (error) throw error;
      return data || [];
    }

    async function syncGuests({ animateNew = false } = {}) {
      const rows = await fetchCheckedInGuests();

      rows.slice(0, CONFIG.MAX_GUESTS).forEach((g) => {
        if (!g?.character_name || !g?.real_name) return;

        const prev = guestMap.get(g.character_name);
        const isNew = !prev;

        guestMap.set(g.character_name, g);
        renderOrUpdateGuestCard(g, { animate: animateNew && isNew });
      });

      updateGuestCountTicker();
    }

    /**********************************************************************
     * =====================================================================
     * TICKER: update guest count
     * =====================================================================
     **********************************************************************/
    function updateGuestCountTicker() {
      const checkedInCount = Array.from(guestMap.values()).filter(g => g && g.real_name).length;
      document.querySelectorAll('.guest-count').forEach(el => el.textContent = String(checkedInCount));
    }

    /**********************************************************************
     * =====================================================================
     * SPOTLIGHT (always visible, rotates checked-in guests)
     * =====================================================================
     **********************************************************************/
    function getCheckedInGuestsSorted() {
      const guests = Array.from(guestMap.values()).filter(g => g && g.real_name);
      guests.sort((a, b) => {
        const ta = a.created_at ? new Date(a.created_at).getTime() : 0;
        const tb = b.created_at ? new Date(b.created_at).getTime() : 0;
        return ta - tb;
      });
      return guests;
    }

    function renderSpotlight() {
      const box = document.getElementById('spotlightBox');
      const guests = getCheckedInGuestsSorted();

      if (guests.length === 0) {
        box.innerHTML = `
          <div class="spotlight">
            <div class="spotlight-name">AWAITING CHECK-INS…</div>
            <div class="spotlight-title">SYSTEM STATUS</div>
            <div class="spotlight-desc">No guests have checked in yet.</div>
            <div class="spotlight-underline"></div>
          </div>
        `;
        return;
      }

      const guest = guests[spotlightIndex % guests.length];
      spotlightIndex++;

      box.innerHTML = `
        <div class="spotlight">
          <div class="spotlight-name">${escapeHTML(guest.character_name)}</div>
          <div class="spotlight-title">${escapeHTML(guest.character_title || 'Mystery Guest')}</div>
          <div class="spotlight-desc">${escapeHTML(guest.character_description || 'No description')}</div>
          <div class="spotlight-underline"></div>
        </div>
      `;
    }

    /**********************************************************************
     * =====================================================================
     * REALTIME SUBSCRIPTION ✅ This is the critical “old working” part:
     * On ANY change, if the row has real_name, we immediately update the card.
     * =====================================================================
     **********************************************************************/
    function setupRealtime() {
      sbClient
        .channel('guests-live')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'guests' }, (payload) => {
          const g = payload.new;

          if (CONFIG.DEBUG) console.log('[RT EVENT]', payload.eventType, g);

          // Only render people who are "checked in"
          if (!g || !g.character_name || !g.real_name) return;

          // Respect max guests
          if (guestMap.size >= CONFIG.MAX_GUESTS && !guestMap.has(g.character_name)) return;

          const wasMissing = !guestMap.has(g.character_name);

          // Update state
          guestMap.set(g.character_name, g);

          // ✅ THE IMPORTANT PART: update wall immediately
          renderOrUpdateGuestCard(g, { animate: wasMissing });

          // Update ticker/spotlight data
          updateGuestCountTicker();
        })
        .subscribe((status) => {
          if (CONFIG.DEBUG) console.log('[Realtime status]', status);
        });
    }

    /**********************************************************************
     * =====================================================================
     * INIT
     * =====================================================================
     **********************************************************************/
    async function init() {
      updateCountdown();

      // initial load
      try {
        await syncGuests({ animateNew: false });
      } catch (e) {
        console.error('[Initial sync error]', e);
      }

      // start realtime + fallback poll
      setupRealtime();
      setInterval(() => {
        syncGuests({ animateNew: true }).catch((e) => CONFIG.DEBUG && console.warn('[Poll sync error]', e));
      }, CONFIG.POLL_FALLBACK_MS);

      // loops
      renderSpotlight();
      setInterval(updateCountdown, 1000);
      setInterval(renderSpotlight, CONFIG.SPOTLIGHT_ROTATE_MS);
    }

    init();
  </script>
</body>
</html>
